<?php
/**
 * Copyright (C) 2019 Paladin Business Solutions
 *
 */

$website_name = get_bloginfo('name') ;

$mobile_list = $wpdb->get_results( $wpdb->prepare("SELECT `ringcentral_token`, `full_name`, `mobile`
    FROM `ringcentral_contacts` WHERE `mobile` <> %s AND `mobile_confirmed` = %d", "", 1 ) ); 

$sdk = ringcentral_sdk() ;

$from = ringcentral_get_from();

foreach ( $mobile_list as $mobile_contact ) {
    $unsub_url = RINGCENTRAL_PLUGINURL . "includes/ringcentral-unsubscribe.php?contact_id=" . $mobile_contact->ringcentral_token;
    $unsub_url .= "&method=2" ;
    
    $message = "hi $mobile_contact->full_name : A new post has been added to:  $website_name \n\n";
    $message .= $post->post_title . ": " . $post_url . "\n\n";
    $message .= "To unsubscribe follow this link: " ;
    $message .= "$unsub_url ";
    
    try {
        $apiResponse = $sdk->platform()->post('/account/~/extension/~/sms',
            array('from' => array('phoneNumber' => $from),
                'to'   => array( array('phoneNumber' => $mobile_contact->mobile) ),
                'text' => $message ) );
    } catch (\RingCentral\SDK\Http\ApiException $e) {
        
        // Getting error messages using PHP native interface
        //                     print 'Expected HTTP Error: ' . $e->getMessage() . PHP_EOL;
        
        // In order to get Request and Response used to perform transaction:
        $apiResponse = $e->apiResponse();
        //                     print_r($apiResponse->request());
        //                     print_r($apiResponse->response());
        
        // Another way to get message, but keep in mind, that there could be no response if request has failed completely
        // print '  Message: ' . $e->apiResponse->response()->error() . PHP_EOL;
        // $message = '  Message: ' . $e->apiResponse->response()->error() . PHP_EOL;
        // craft a friendly message here.
        $return_message = "There was an error broadcasting to the mobile list => " . $apiResponse;
    }
	// Sleep for 1.8 seconds to prevent 40/min penalty
	usleep(1800000);
}
?>